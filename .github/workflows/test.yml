name: Test
on:
  push:
jobs:     
  run:
    strategy:
      fail-fast: false
      matrix:
        php: ['5.6', '7.3', '7.4']
        os: [ubuntu-18.04, macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
    - uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ matrix.php }}        
    - name: Test
      run: |
        scan_dir=$(php --ini | grep additional | sed -e "s|.*: s*||")  
        curl -o /tmp/geos.tar.gz -sL https://git.osgeo.org/gitea/geos/php-geos/archive/master.tar.gz
        tar -xzf /tmp/geos.tar.gz -C /tmp
        if [ "$(uname -s)" = "Darwin" ]; then
          brew install geos
          if [ "$(php -r "echo PHP_VERSION_ID;")" -ge 70000 ]; then
            sed -i '' "s/ce->name/ZSTR_VAL(ce->name)/" /tmp/geos-php/geos.c
          fi          
        else
          sudo apt-get install libgeos-dev
          if (( "$(php -r "echo PHP_VERSION_ID;")" < 70000 )); then
            sed -i "s/ce->name/ZSTR_VAL(ce->name)/" /tmp/geos-php/geos.c
          fi          
        fi        
        (
          cd /tmp/php-geos
          phpize
          ./configure --enable-geos --with-geos-config=$(command -v geos-config)
          sudo make
          ls ./modules
          sudo make install
          echo "extension=geos.so" | sudo tee -a "$scan_dir/50-geos.ini"
        )
        php -v
        php -m
        php -r "if(! extension_loaded('geos')) {throw new Exception('geos not found');}"
