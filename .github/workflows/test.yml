name: oldphp on windows

on: [push, pull_request]

jobs:
  oldphp-ubuntu:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        php-versions: ['8.0', '8.1']
        os: [ubuntu-18.04]
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Install PHP
        uses: shivammathur/setup-php@verbose
        with:
          php-version: ${{ matrix.php-versions }}
      - run: php -v
      - run: php -m
      - run: php-cgi -v
      - run: php-fpm -v
      - run: sudo service php${{ matrix.php-versions }}-fpm status
      - run: sudo apt-get install nginx -y
      - run: |
          cat <<EOF | sudo tee /etc/nginx/sites-available/default
          server {
              listen 80 default_server;
              listen [::]:80 default_server;

              root /var/www/html;
              index index.php index.html index.htm index.nginx-debian.html;

              server_name localhost;

              location / {
                  try_files $uri $uri/ =404;
              }

              location ~ \.php$ {
                  include snippets/fastcgi-php.conf;
                  fastcgi_pass unix:/run/php/php${{ matrix.php-versions }}-fpm.sock;
              }

              location ~ /\.ht {
                  deny all;
              }
          }
          EOF
          sudo cat /etc/nginx/sites-available/default
      - run: |  
          sudo service php${{ matrix.php-versions }}-fpm restart
          sudo nginx -s reload
          sudo service php${{ matrix.php-versions }}-fpm status
          sudo service nginx status
      - run: |   
          cat <<EOF | sudo tee /var/www/html/info.php
          <?php
          echo phpversion();
          echo "\nHello World";
          EOF
          sudo cat /var/www/html/info.php
      - run: php /var/www/html/info.php
      - run: sudo curl http://localhost/info.php
      - run: sudo cat /var/log/nginx/error.log
