name: 'Extension workflow'
on:
  push:
jobs:
  run:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        #php: ['5.6', '7.0', '7.1', '7.2', '7.3', '7.4']
        icu: [65.1]
        php: [5.6, 7.4]
        #icu: [67.1, 66.1, 65.1, 64.2, 63.2, 62.2, 61.2, 60.3, 59.2, 58.3, 57.2, 56.2, 55.2, 54.2, 53.2, 52.2, 51.3, 50.2]
    name: PHP
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Update intl
        env:
          icu: ${{ matrix.icu }}
          version: ${{ matrix.php }}
        run: |
          sudo apt-get -y update
          sudo apt-get install sudo gnupg curl make software-properties-common unzip
          LC_ALL=C.UTF-8 sudo apt-add-repository ppa:ondrej/php -y
          sudo apt-get -y update
          sudo apt-get install php$version php$version-xml php$version-dev
          php -v
          php -m
          ext_dir=$(php -i | grep "extension_dir => /" | sed -e "s|.*=> s*||")
          scan_dir=$(php --ini | grep additional | sed -e "s|.*: s*||")
          ini_file=$(php --ini | grep "Loaded Configuration" | sed -e "s|.*:s*||" | sed "s/ //g")
          pecl_file="$scan_dir"/99-pecl.ini          
          get_tag() {
            master_version='8.0'
            tag='master'
            if [ ! "${version:?}" = "$master_version" ]; then
              tag="php-$(php -v | head -n 1 | cut -f 2 -d ' ' | cut -f 1 -d '-')"
            fi
            echo "$tag"
          }
          get_php() {
            curl -sL "https://github.com/php/php-src/archive/$tag.tar.gz" | tar xzf - -C "/tmp"
          }
          check_extension() {
            extension=$1
            if [ "$extension" != "mysql" ]; then
              php -m | grep -i -q -w "$extension"
            else
              php -m | grep -i -q "$extension"
            fi
          }          
          enable_extension() {
            if ! check_extension "$1" && [ -e "$ext_dir/$1.so" ]; then
              echo "$2=$1.so" >>"$pecl_file"
            fi
          }
          install_icu() {
            sudo curl -o /tmp/icu.tar.zst -sL https://dl.bintray.com/shivammathur/icu4c/icu4c-$icu.tar.zst            
            sudo tar -I zstd -xf /tmp/icu.tar.zst -C /usr/local
            export LD_LIBRARY_PATH=/usr/local/icu/lib            
          }
          install_intl() {
            tag=$(get_tag)
            get_php
            (
              cd "/tmp/php-src-$tag/ext/intl" || exit 1              
              phpize && sudo ./configure --with-php-config="$(command -v php-config)" --enable-intl
              sudo make CXXFLAGS="-O2 -std=c++11 -DU_USING_ICU_NAMESPACE=1 $CXXFLAGS"
              sudo cp ./modules/* "$ext_dir/"
              enable_extension intl extension
            )
          }
          install_icu
          install_intl
      - name: Testing PHP
        run: |
          icu_version=$(php -i | grep "ICU version =>" | sed -e "s|.*=> s*||")
          echo $icu_version
          [ "$icu_version" != "${{ matrix.icu }}" ] && exit 1
          php -v
          php -m
