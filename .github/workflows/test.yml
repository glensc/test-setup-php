  
name: Runner workflow
on:
  push:
jobs:
  ubuntu:
    name: runner
    runs-on: ubuntu-latest
    steps:
      - name: Setup PHP
        uses: shivammathur/setup-php@develop
        with:
          php-version: 7.4
          tools: pecl
          extensions: protobuf
      - name: Test
        run: |
          php -v && php -m
          protobuf_tag=$(curl -sSL https://api.github.com/repos/protocolbuffers/protobuf/releases | grep -Eo "(v[0-9]+.[0-9]+.[0-9]+)" | head -n 1)
          curl -o /tmp/protobuf.zip -sSL "https://github.com/protocolbuffers/protobuf/releases/download/$protobuf_tag/protoc-${protobuf_tag:1}-linux-x86_64.zip"
          sudo unzip /tmp/protobuf.zip -d /
          git clone https://github.com/grpc/grpc
          cd grpc
          bazel --batch_cpu_scheduling --io_nice_level 7 build --jobs 6 --local_ram_resources=HOST_RAM*0.5 src/compiler:grpc_php_plugin
          sudo cp ./bazel-bin/src/compiler/grpc_php_plugin /usr/bin/grpc_php_plugin
          sudo chmod a+x /bin/protoc /usr/bin/grpc_php_plugin
          cd examples/php
          protoc --proto_path=../protos --php_out=. --grpc_out=. --plugin=protoc-gen-grpc=/bin/grpc_php_plugin ../protos/helloworld.proto
          ls .
          ls ../protos
          composer install
