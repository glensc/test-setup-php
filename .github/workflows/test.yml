name: Test

on:
  push:

jobs:
  build:
    name: Test
    container: ubuntu:focal
    runs-on: "ubuntu-latest"
    steps:
    - run: |
        export _APTMGR=apt-get
        apt-get update && apt-get install -y curl sudo software-properties-common
        add-apt-repository ppa:git-core/ppa        
        add-apt-repository ppa:apt-fast/stable
        LC_ALL=C.UTF-8 add-apt-repository ppa:ondrej/php
        apt-get update
        DEBIAN_FRONTEND=noninteractive apt-get install -y git sudo apt-fast gcc make automake pkg-config shtool
    - run: |
        cd /
        git config --global user.email "you@example.com"
        git init
        git add /bin /etc /lib /lib64 /sbin /usr /var
        git commit -m "init"        
    - run: |
        cd /tmp
        version='5.6'
        curl -o /tmp/php.sh -sSL https://raw.githubusercontent.com/actions/virtual-environments/main/images/linux/scripts/installers/php.sh
        sed -i "s/^php_versions.*/php_versions=$version/" /tmp/php.sh
        sed -i '/ snmp\|php-pear\|composer\|phpunit\|invoke_tests\|source/d' /tmp/php.sh
        sudo bash /tmp/php.sh || true
        sudo rm -rf /var/cache/apt/archives/*.deb || true
    - run: |
        cd /
        git add /bin /etc /lib /lib64 /sbin /usr /var
        git commit -m "installed php"
        mkdir -p /tmp/php
        for file in $(git log -p -n 1 --name-only); do
          sudo cp -r -p --parents "$file" /tmp/php || true
        done  
        (
          cd /tmp/php
          tar -czf ../php.tar.gz *        
        )
    - uses: actions/upload-artifact@v2
      with:
        name: php.tar.gz
        path: /tmp/php.tar.gz
