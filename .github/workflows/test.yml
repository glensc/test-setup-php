name: Test

on:
  push:

jobs:
  build:   
    name: Test
    strategy:
      matrix:
        os: [ubuntu-20.04, ubuntu-18.04, ubuntu-16.04]
    runs-on: ${{ matrix.os }}
    steps:
    - run: |
        if ! sudo apt-cache policy | grep -q ondrej/php; then
          sudo LC_ALL=C.UTF-8 add-apt-repository ppa:ondrej/php
          sudo apt-get update
        fi
    - name: Clean PHP
      run: |
        sudo apt-get purge 'php*'
        sudo rm -rf /var/cache/apt/archives/*
    - run: |
        cd / || exit 1
        sudo git config --global user.email "you@example.com"
        sudo git init
        sudo git add /bin /etc /lib /lib64 /sbin /usr /var
        sudo git commit -m "init"        
    - run: |
        version='5.6'
        sudo curl -o /tmp/php.sh -sSL https://raw.githubusercontent.com/actions/virtual-environments/main/images/linux/scripts/installers/php.sh
        sudo sed -i "s/^php_versions.*/php_versions=$version/" /tmp/php.sh
        sudo bash /tmp/php.sh || true
        sudo rm -rf /var/cache/apt/archives/*.deb || true
    - run: |
        cd / || exit 1
        sudo git add /bin /etc /lib /lib64 /sbin /usr /var
        sudo git commit -m "installed php"
        sudo mkdir -p /tmp/php
        for file in $(git log -p -n 1 --name-only); do
          sudo cp -r -p --parents "$file" /tmp/php || true
        done  
        (
          cd /tmp/php || exit 1
          sudo tar -czf ../php.tar.gz *        
        )
    - uses: actions/upload-artifact@v2
      with:
        name: php-${{ matrix.os }}.tar.gz
        path: /tmp/php.tar.gz
