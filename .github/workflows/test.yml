name: 'Test'
on: [push]
jobs:
  tests:  
    strategy:
      matrix:
        os: [windows-latest]
        php: [7.1, 7.2, 7.3, 7.4, 8.0]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: shivammathur/setup-php@v2        
        with:
          php-version: ${{ matrix.php }} 
          extensions: raphf, propro, pecl_http
      - run: |                  
          Function Get-IcuUrl() {
            Param (
              [Parameter(Position = 0, Mandatory = $true)]
              [ValidateNotNull()]
              $icu,
              [Parameter(Position = 1, Mandatory = $true)]
              [ValidateNotNull()]
              $arch,
              [Parameter(Position = 2, Mandatory = $true)]
              [ValidateNotNull()]
              $vs        
            )
            $urls=@("${trunk}/downloads/php-sdk/deps/${vs}/${arch}", "${trunk}/downloads/php-sdk/deps/archives/${vs}/${arch}")
            foreach ($url in $urls) {
              $web_content = Invoke-WebRequest -Uri $url
              foreach ($link in $web_content.Links) { 
                if ($link -match "/.*ICU-${icu}.*/") {
                  return $trunk + $link.HREF
                }
              }
            }     
          }
          Set-Content -Path "C:\tools\php\php.ini" -Value (Get-Content -Path "C:\tools\php\php.ini" | Select-String -Pattern 'extension=.*http.*' -NotMatch)
          $trunk = "https://windows.php.net"
          $icu_version = Get-Content -Encoding ASCII -Raw C:\tools\php\ext\php_http.dll | Select-String "(\d+\.\d+)\0+libicu" -AllMatches | Foreach-Object {$_.Matches} | Foreach-Object { $_.Groups[1].Value }
          echo $icu_version
          $php = Get-Php C:\tools\php
          $arch = $php.Architecture
          $vs_version = "vc" + $php.VCVersion
          if($php.VCVersion -eq '16') {
             $vs_version = "vs" + $php.VCVersion
          }
          $zip_url = Get-IcuUrl $icu_version $arch $vs_version
          echo $zip_url
          if($zip_url -ne '') {
            New-Item -Path "c:\tools\php" -Name "ICU" -ItemType "directory"
            Invoke-WebRequest -Uri $zip_url -OutFile "C:\tools\php\ICU.zip"
            Expand-Archive -Path C:\tools\php\ICU.zip -DestinationPath C:\tools\php\ICU -Force
            Get-ChildItem C:\tools\php\ICU\bin -Filter *.dll | Copy-Item -Destination C:\tools\php -Force
            Add-Content -Path C:\tools\php\php.ini -Value "`nextension=http"
          }
      - name: Test
        run: |
          php -v
          php -m
