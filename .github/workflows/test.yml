name: 'Extension workflow'
on:
  push:
jobs:
  run:
    runs-on: ${{ matrix.operating-system }}
    strategy:
      fail-fast: false
      matrix:
        operating-system: [ubuntu-latest, macos-latest]
        php-versions: ['7.4']
    name: PHP ${{ matrix.php-versions }} Test on ${{ matrix.operating-system }}
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Setup PHP
        uses: shivammathur/setup-php@develop
        with:
          php-version: ${{ matrix.php-versions }}
          tools: pecl
      - name: Add oci8 and pdo_oci
        run: |
          version=${{ matrix.php-versions }}
          get_branch() {
            if [ ! "$version" = "$master_version" ]; then
              echo "PHP-$(php -v | head -n 1 | cut -f 2 -d ' ' | cut -f 1 -d '-')"
            else
              echo 'master'
            fi
          }
          sudo mkdir -p -m 777 /opt/oracle
          libs="/usr/lib/"
          for package in basiclite sdk; do
            os=$(uname -s)
            if [ "$os" = "Linux" ]; then
              curl -o "/opt/oracle/$package.zip" -sSL "https://download.oracle.com/otn_software/linux/instantclient/instantclient-$package-linuxx64.zip"
            elif [ "$os" = "Darwin" ]; then
              libs="/usr/local/lib/"
              sudo mkdir /usr/include
              sudo ln -sf /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk/usr/include/php /usr/include/
              curl -o "/opt/oracle/$package.zip" -sSL "https://download.oracle.com/otn_software/mac/instantclient/instantclient-$package-macos.zip"
            fi
            unzip "/opt/oracle/$package.zip" -d /opt/oracle
          done
          sudo ln -sf /opt/oracle/instantclient*/*.so* $libs
          sudo ln -sf /opt/oracle/instantclient* /opt/oracle/instantclient     
          git clone -b $(get_branch) https://github.com/php/php-src /opt/oracle/php
          for extension in oci8 pdo_oci; do
            (
              cd "/opt/oracle/php/ext/$extension"
              phpize && ./configure --with-php-config=/usr/bin/php-config --with-"$extension"=instantclient,/opt/oracle/instantclient
              make && sudo make install
              echo "extension=$extension" | sudo tee -a $(pecl config-get php_ini)
            )
          done        
      - name: Testing PHP version
        run: php -v
      - name: Testing Extensions
        run: php -m
