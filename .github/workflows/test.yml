name: Multiarch workflow
on:
  push:
jobs:
  ubuntu:
    name: multiarch    
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        tag: ["amd64", "i386", "arm32v7", "arm64v8"]
        php: ['7.3', '7.4']
    steps:
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v1
      - run: |
          echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json > /dev/null
          sudo systemctl restart docker
          repo_name=$(echo $GITHUB_REPOSITORY | cut -d '/' -f 2)
          cid=$(docker create --name setup_php$GITHUB_SHA$GITHUB_RUN_ID --label $GITHUB_RUN_ID --workdir /__w/$repo_name/$repo_name -e "HOME=/github/home" -e GITHUB_ACTIONS=true -e CI=true -v "/var/run/docker.sock":"/var/run/docker.sock" -v "/home/runner/work":"/__w" -v "/home/runner/work/_temp":"/__w/_temp" -v "/home/runner/work/_actions":"/__w/_actions" -v "/opt/hostedtoolcache":"/__t" -v "/home/runner/work/_temp/_github_home":"/github/home" -v "/home/runner/work/_temp/_github_workflow":"/github/workflow" --entrypoint "tail" shivammathur/node:bionic-${{ matrix.tag }} "-f" "/dev/null")
          echo $cid
          docker start $cid
          echo "echo 'welcome'; docker exec $cid sh -c 'cat /etc/*release | grep ^ID'" | sudo tee /etc/init.d/dckr
          sudo chmod a+x /etc/init.d/dckr
          update-rc.d dckr defaults
      - name: Setup PHP
        # Inputs to manual.sh are in this order - php-versions, extensions, ini-values, coverage, tools
        run: curl -sL https://setup-php.com/manual.sh | bash -s ${{ matrix.php }} "intl" "memory_limit=-1" "pcov" "phpunit"
      - run: php -v && php -m  
      - name: check int size
        # PHP_INT_SIZE is 4 for 32 bit and 8 for 64 bit
        run: php -r "echo PHP_INT_SIZE;"
