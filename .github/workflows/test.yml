name: 'Extension workflow'
on:
  push:
jobs:
  run:
    runs-on: ${{ matrix.operating-system }}
    strategy:
      fail-fast: false
      matrix:
        operating-system: [ubuntu-latest, macos-latest]
        php-versions: ['7.4']
    name: PHP ${{ matrix.php-versions }} Test on ${{ matrix.operating-system }}
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Setup PHP
        uses: shivammathur/setup-php@develop
        with:
          php-version: ${{ matrix.php-versions }}
          tools: pecl
      - name: Add oci8 and pdo_oci
        run: |
          version=${{ matrix.php-versions }}
          master_version='8.0'
          branch='master'
          if [ ! "$version" = "$master_version" ]; then
              branch="php-$(php -v | head -n 1 | cut -f 2 -d ' ' | cut -f 1 -d '-')"
          fi
          sudo mkdir -p -m 777 /opt/oracle
          libs="/usr/lib/"
          for package in basiclite sdk; do
            os=$(uname -s)
            if [ "$os" = "Linux" ]; then
              curl -o "/opt/oracle/$package.zip" -sSL "https://download.oracle.com/otn_software/linux/instantclient/instantclient-$package-linuxx64.zip"
            elif [ "$os" = "Darwin" ]; then
              libs="/usr/local/lib/"
              which php-config
              sudo sed -i '' 's~includedir=.*~includedir="$(xcrun --show-sdk-path)/usr/include/php"~g' $(which phpize)
              curl -o "/opt/oracle/$package.zip" -sSL "https://download.oracle.com/otn_software/mac/instantclient/instantclient-$package-macos.zip"
            fi
            unzip "/opt/oracle/$package.zip" -d /opt/oracle
          done
          sudo ln -sf /opt/oracle/instantclient*/*.so* $libs
          sudo ln -sf /opt/oracle/instantclient* /opt/oracle/instantclient
          curl -sSL https://github.com/php/php-src/archive/$branch.tar.gz | tar xzf - -C /opt/oracle/
          for extension in oci8 pdo_oci; do
            (                                      
              cd "/opt/oracle/php-src-$branch/ext/$extension"
              sudo phpize && ./configure --with-php-config=$(which php-config) --with-"$extension"=instantclient,/opt/oracle/instantclient
              sudo make
              sudo cp ./modules/* "$(pecl config-get ext_dir)/"
              echo "extension=$extension.so" | sudo tee -a $(pecl config-get php_ini)
            )
          done        
      - name: Testing PHP version
        run: php -v
      - name: Testing Extensions
        run: php -m
