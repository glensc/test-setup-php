  
name: Runner workflow
on:
  push:
jobs:
  ubuntu:
    name: runner
    runs-on: ubuntu-latest
    steps:
      - name: Setup PHP
        uses: shivammathur/setup-php@develop
        with:
          php-version: 7.4
          tools: pecl
          extensions: protobuf
      - name: Test
        run: |
          add_protoc() {
            protobuf_tag=$(curl -sSL "https://api.github.com/repos/protocolbuffers/protobuf/releases/latest" | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
            curl -o /tmp/protobuf.zip -sSL "https://github.com/protocolbuffers/protobuf/releases/download/$protobuf_tag/protoc-${protobuf_tag:1}-linux-x86_64.zip"
            sudo unzip /tmp/protobuf.zip -d /
            sudo chmod a+x /bin/protoc
          }
          add_grpc_php_plugin() {
            grpc_tag=$(curl -sSL https://grpc.io/release)
            curl -sSL "https://github.com/grpc/grpc/archive/$grpc_tag.tar.gz" | tar -xz -C /tmp
            (
              cd /tmp/grpc-${grpc_tag:1}
              bazel build src/compiler:grpc_php_plugin
              sudo cp ./bazel-bin/src/compiler/grpc_php_plugin /usr/bin/grpc_php_plugin
              sudo chmod a+x /usr/bin/grpc_php_plugin
            )
          }
          test() {
            cd /tmp/grpc*/examples/php
            protoc --proto_path=../protos --php_out=. --grpc_out=. --plugin=protoc-gen-grpc=/usr/bin/grpc_php_plugin ../protos/helloworld.proto
            composer install
          }
          add_protoc
          add_grpc_php_plugin
          test       
