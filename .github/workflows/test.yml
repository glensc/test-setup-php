name: 'Extension workflow'
on:
  push:
jobs:
  run:
    runs-on: ${{ matrix.operating-system }}
    strategy:
      fail-fast: false
      matrix:
        operating-system: [ubuntu-latest]
        php-versions: ['5.3', '5.4', '5.5', '5.6', '7.0', '7.1', '7.2', '7.3', '7.4']
    name: PHP ${{ matrix.php-versions }} Test on ${{ matrix.operating-system }}
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Setup PHP
        uses: shivammathur/setup-php@verbose
        with:
          php-version: ${{ matrix.php-versions }}
      - name: Install cubrid
        shell: bash
        run: |
          set_cubrid_repo() {
            case "${ext:?}" in
              "cubrid") cubrid_repo="cubrid-php";;
              "pdo_cubrid") cubrid_repo="cubrid-pdo";;
            esac
          }
          set_cubrid_branch() {
            case "${version:?}" in
              5.[3-6]) cubrid_branch="RB-9.3.0";;
              *) cubrid_branch="develop";;
            esac
          }
          add_cubrid() {
            ext=$1
            set_cubrid_repo
            set_cubrid_branch
            git clone -b "$cubrid_branch" --recursive "https://github.com/CUBRID/$cubrid_repo" "/tmp/$cubrid_repo"
            (
              cd "/tmp/$cubrid_repo" || exit
              export CXXFLAGS="$CXXFLAGS -std=c++11"
              export CC="clang"
              export CXX="clang++"
              phpize && ./configure --with-php-config="$(command -v php-config)" --with-"${ext/_/-}"=shared
              make -j$(nproc)
              sudo make install            
            )
            echo "extension=$ext.so" | sudo tee "$scan_dir/$ext.ini"
          }
          version=${{ matrix.php-versions }}
          old_versions="5.[3-5]"
          debconf_fix="DEBIAN_FRONTEND=noninteractive"
          scan_dir=$(php --ini | grep additional | sed -e "s|.*: s*||")
          if ! [[ "$version" =~ $old_versions ]]; then
            sudo "$debconf_fix" apt-get install -y "php$version-dev"
            sudo update-alternatives --set php-config /usr/bin/php-config"$version"
            sudo update-alternatives --set phpize /usr/bin/phpize"$version"
          fi
          add_cubrid cubrid || true
          add_cubrid pdo_cubrid || true
      - name: Testing PHP version
        run: php -v
      - name: Testing Extensions
        run: |
          php -m
          php -r "if(! extension_loaded('cubrid')) {throw new Exception('cubrid not found');}"
          php -r "if(! extension_loaded('pdo_cubrid')) {throw new Exception('pdo_cubrid not found');}"
