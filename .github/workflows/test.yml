name: 'Extension workflow'
on:
  push:
jobs:
  run:
    runs-on: ${{ matrix.operating-system }}
    strategy:
      fail-fast: false
      matrix:
        operating-system: [ubuntu-latest]
        php-versions: ['5.3', '5.4', '5.5', '5.6', '7.0', '7.1', '7.2', '7.3', '7.4']
    name: PHP ${{ matrix.php-versions }} Test on ${{ matrix.operating-system }}
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Setup PHP
        uses: shivammathur/setup-php@develop
        with:
          php-version: ${{ matrix.php-versions }}
          tools: pecl
      - name: Add oci8 and pdo_oci
        continue-on-error: true
        run: |
          # Function to log result of a operation
          add_log() {
            mark=$1
            subject=$2
            message=$3
            if [ "$mark" = "$tick" ]; then
              printf "\033[32;1m%s \033[0m\033[34;1m%s \033[0m\033[90;1m%s\033[0m\n" "$mark" "$subject" "$message"
            else
              printf "\033[31;1m%s \033[0m\033[34;1m%s \033[0m\033[90;1m%s\033[0m\n" "$mark" "$subject" "$message"
            fi
          }
          # Function to test if extension is loaded.
          check_extension() {
            extension=$1
            if [ "$extension" != "mysql" ]; then
              php -m | grep -i -q -w "$extension"
            else
              php -m | grep -i -q "$extension"
            fi
          }
          # Function to get the tag for a php version
          get_tag() {
            master_version='8.0'
            tag='master'
            if [ ! "$version" = "$master_version" ]; then
                tag="php-$(php -v | head -n 1 | cut -f 2 -d ' ' | cut -f 1 -d '-')"
            fi
            echo "$tag"
          }
          # Function to fetch the client and sdk
          get_client() {
            echo 'get_client'
            sudo mkdir -p -m 777 "$oracle_home" "$oracle_client/network/admin"
              if [ ! -e "$oracle_client" ]; then
                for package in basiclite sdk; do
                  if [ "$os" = 'Linux' ]; then
                    libs='/usr/lib/'
                    os_name='linux'
                    lib_ext='so'
                  elif [ "$os" = 'Darwin' ]; then
                    libs='/usr/local/lib/'
                    os_name='macos'
                    lib_ext='dylib'
                  fi
                  curl -o "/opt/oracle/$package.zip" -sSL "https://dl.bintray.com/shivammathur/playground/instantclient-$package-$os_name.x64-12.1.0.2.0.zip"
                  unzip "/opt/oracle/$package.zip" -d "$oracle_home"
                done
                sudo ln -sf /opt/oracle/instantclient* /opt/oracle/instantclient
                (
                  cd "$oracle_client" || exit
                  sudo ln -s libclntsh."$lib_ext".12.1 libclntsh."$lib_ext"
                  sudo ln -s libocci."$lib_ext".12.1 libocci."$lib_ext"
                )
                sudo ln -sf /opt/oracle/instantclient*/*.$lib_ext* $libs
                sudo sh -c "echo /opt/oracle/instantclient > /etc/ld.so.conf.d/oracle-instantclient.conf"
                sudo ldconfig           
            fi
            echo 'get_client_exit'
          }
          # Function to get PHP source
          get_php() {
            echo 'get_php'
            [ ! -d "/opt/oracle/php-src-$tag" ] && curl -sSL "https://github.com/php/php-src/archive/$tag.tar.gz" | tar xzf - -C "$oracle_home/"
            echo 'get_php_exit'
          }
          # Function to get phpize location on darwin
          get_phpize() {
            if [[ "$version" =~ 5.[3-5] ]]; then
                echo '/opt/local/bin/phpize'
            else
                echo "/usr/local/bin/$(readlink /usr/local/bin/phpize)"
            fi
          }
          # Function to patch phpize to link to php headers
          patch_phpize() {
            if [ "$os" = "Darwin" ]; then
              sudo cp "$phpize_orig" "$phpize_orig.bck"
              sudo sed -i '' 's~includedir=.*~includedir="$(xcrun --show-sdk-path)/usr/include/php"~g' "$phpize_orig"
            fi
          }
          # Function to restore phpize
          restore_phpize() {
            if [ "$os" = "Darwin" ]; then
              sudo mv "$phpize_orig.bck" "$phpize_orig" || true
            fi
          }
          # Function to patch pdo_oci
          patch_pdo_oci_config() {
            curl -sSLO https://raw.githubusercontent.com/php/php-src/master/ext/pdo_oci/config.m4
            sudo sed -i '' "/PHP_CHECK_PDO_INCLUDES/d" config.m4 || sudo sed -i "/PHP_CHECK_PDO_INCLUDES/d" config.m4
          }
          # Function to install the dependencies
          install_dependencies() {
            if [ "$os" = 'Linux' ] && [ "$runner" = "self-hosted" ]; then
              sudo DEBIAN_FRONTEND=noninteractive apt-fast install -y autoconf automake libaio-dev gcc g++
            fi
          }
          # Function to install the extension
          install_extension() {
            (
              cd "/opt/oracle/php-src-$tag/ext/$ext" || exit 1
              [ "$ext" = "pdo_oci" ] && patch_pdo_oci_config
              sudo phpize && ./configure --with-php-config="$(command -v php-config)" --with-"${ext/_/-}"=shared,instantclient,"$oracle_client"
              sudo make -j"$(nproc)"
              sudo cp ./modules/* "$(php -i | grep "extension_dir => /" | sed -e "s|.*=> s*||")/"
              echo "extension=$ext.so" | sudo tee "$(php --ini | grep additional | sed -e "s|.*: s*||")/99-$ext.ini"
              (check_extension "$ext" && add_log "$tick" "$ext" "Enabled") || add_log "$cross" "$ext" "Could not install $ext"
            )
          }
          tick="✓"
          cross="✗"
          version=${{ matrix.php-versions }}
          oracle_home='/opt/oracle'
          oracle_client=$oracle_home/instantclient
          runner="${runner:-github}"                 
          os=$(uname -s)
          tag=$(get_tag)
          phpize_orig=$(get_phpize)
          for ext in oci8 pdo_oci; do            
            get_client
            get_php
            patch_phpize
            install_dependencies
            install_extension
            restore_phpize
          done
      - name: Testing PHP version
        run: php -v
      - name: Testing Extensions
        run: |
          php -m
          php -r "if(! extension_loaded('oci8')) {throw new Exception('oci8 not found');}"
          php -r "if(! extension_loaded('PDO_OCI')) {throw new Exception('PDO_OCI not found');}"
