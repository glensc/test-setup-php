name: 'Extension workflow'
on:
  push:
jobs:
  run:
    runs-on: ${{ matrix.operating-system }}
    strategy:
      fail-fast: false
      matrix:
        operating-system: [ubuntu-latest, macos-latest]
        php-versions: ['5.6', '7.4']
    name: PHP ${{ matrix.php-versions }} Test on ${{ matrix.operating-system }}
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Setup PHP
        uses: shivammathur/setup-php@verbose
        with:
          php-version: ${{ matrix.php-versions }}
      - name: Install cubrid
        run: |
          version=${{ matrix.php-versions }}
          case "$version" in
            5.[3-6]) branch="RB-9.3.0";;
            *) branch="develop";;
          esac
          debconf_fix="DEBIAN_FRONTEND=noninteractive"
          scan_dir=$(php --ini | grep additional | sed -e "s|.*: s*||")
          git clone -b $branch --recursive https://github.com/CUBRID/cubrid-php
          (
            cd cubrid-php || exit
            if [ $(uname -s) = "Linux" ]; then
              sudo "$debconf_fix" apt-get install -y "php$version-dev"
              sudo update-alternatives --set php-config /usr/bin/php-config"$version"
              sudo update-alternatives --set phpize /usr/bin/phpize"$version"
            elif [ $(uname -s) = "Darwin" ]; then
              brew install coreutils
              sudo ln -sf /usr/local/bin/greadlink /usr/local/bin/readlink
              sudo ln -sf /usr/local/bin/glibtoolize /usr/local/bin/libtoolize
            fi            
            phpize
            ./configure --with-cubrid=shared --with-php-config=$(which php-config)
            make -j$(nproc)
            sudo make install            
          )
          echo "extension=cubrid.so" | sudo tee -a $scan_dir/cubrid.ini
      - name: Testing PHP version
        run: php -v
      - name: Testing Extensions
        run: |
          php -m
