name: Test
on: push
jobs:
  backend-tests:
    name: PHP ${{ matrix.php }}

    runs-on: ubuntu-latest
    strategy:
      matrix:
        php: [ "7.3", "7.4", "8.0" ]
    env:
      extensions: mbstring, ctype, curl, gd, apcu, memcached, pcov
      ini: apc.enabled=1, apc.enable_cli=1, pcov.directory=., "pcov.exclude=\"~(vendor|tests)~\""

    steps:
      - run: |
          sudo chown -Rv _apt:root /var/cache/apt/archives/partial/
          sudo chmod -Rv 700 /var/cache/apt/archives/partial/
      - name: Setup PHP cache environment
        id: ext-cache
        uses: shivammathur/cache-extensions@develop
        with:
          php-version: ${{ matrix.php }}
          extensions: ${{ env.extensions }}
          key: php-v1
      - run: |
          ls /etc/php/${{ matrix.php }}/cli/conf.d || true
      - name: Cache PHP extensions
        uses: actions/cache@v2
        with:
          path: ${{ steps.ext-cache.outputs.dir }}
          key: ${{ steps.ext-cache.outputs.key }}
          restore-keys: ${{ steps.ext-cache.outputs.key }}
      - run: ls ${{ steps.ext-cache.outputs.dir }}
      - name: Setup PHP environment
        uses: shivammathur/setup-php@verbose
        with:
          php-version: ${{ matrix.php }}
          extensions: ${{ env.extensions }}
          ini-values: ${{ env.ini }}
          coverage: pcov
          tools: phpunit:^9
