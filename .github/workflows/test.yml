name: 'Extension workflow'
on:
  push:
jobs:
  run:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        #os: [ubuntu-20.04, ubuntu-18.04, ubuntu-16.04]
        php: ['7.4']
        icu: [65.1]
    name: PHP
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Setup PHP
        uses: shivammathur/setup-php@develop
        with:
          php-version: ${{ matrix.php }}
      - name: Build intl
        env:
          icu: ${{ matrix.icu }}
          version: ${{ matrix.php }}
        run: |
          ext_dir=$(php -i | grep "extension_dir => /" | sed -e "s|.*=> s*||")
          scan_dir=$(php --ini | grep additional | sed -e "s|.*: s*||")
          ini_file=$(php --ini | grep "Loaded Configuration" | sed -e "s|.*:s*||" | sed "s/ //g")
          pecl_file="$scan_dir"/99-pecl.ini
          delete_extension() {
            extension=$1
            sudo sed -i "/$extension/d" "$ini_file"
            sudo sed -i "/$extension/d" "$pecl_file"
            sudo rm -rf "$scan_dir"/*"$extension"* >/dev/null 2>&1
            sudo rm -rf "$ext_dir"/"$extension".so >/dev/null 2>&1
          }
          check_extension() {
            extension=$1
            if [ "$extension" != "mysql" ]; then
              php -m | grep -i -q -w "$extension"
            else
              php -m | grep -i -q "$extension"
            fi
          }          
          enable_extension() {
            if ! check_extension "$1" && [ -e "$ext_dir/$1.so" ]; then
              echo "$2=$1.so" >>"$pecl_file"
            fi
          }
          install_icu() {
            sudo curl -o /tmp/icu.tar.zst -sL https://dl.bintray.com/shivammathur/icu4c/icu4c-$icu.tar.zst
            sudo tar -I zstd -xf /tmp/icu.tar.zst -C /usr/local
            sudo cp -r /usr/local/icu/lib/* /usr/lib/x86_64-linux-gnu/
            
          }
          install_intl() {
            sudo curl -o "$ext_dir/intl.so" -sL "https://dl.bintray.com/shivammathur/icu4c/php$version-intl-$icu.so"
            enable_extension intl extension
          }
          delete_extension intl
          install_icu
          install_intl
      - name: Testing PHP
        run: |
          icu_version=$(php -i | grep "ICU version =>" | sed -e "s|.*=> s*||")
          echo $icu_version
          [ "$icu_version" != "${{ matrix.icu }}" ] && exit 1
          php -v
          php -m
