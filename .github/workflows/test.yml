name: 'Extension workflow'
on:
  push:
jobs:
  run:
    runs-on: ${{ matrix.operating-system }}
    strategy:
      fail-fast: false
      matrix:
        operating-system: [windows-latest]
        php-versions: ['7.4']
        ts: [ts, nts]
    name: PHP ${{ matrix.php-versions }} Test on ${{ matrix.operating-system }}
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Setup PHP
        uses: shivammathur/setup-php@develop
        with:
          php-version: ${{ matrix.php-versions }}
        env:
          phpts: ${{ matrix.ts }}
      - name: Add ioncube
        run: |
          $version = '${{ matrix.php-versions }}'
          $tick = ([char]8730)
          $php_dir = 'C:\tools\php'
          if($env:RUNNER -eq 'self-hosted') { $php_dir = "$php_dir$version" }
          $ext_dir = "$php_dir\ext"          
          if(-not(Test-Path $ext_dir\php_ioncube.dll)) {
            $installed = Get-Php $php_dir
            $arch = 'x86-64'
            if(-not([Environment]::Is64BitOperatingSystem) -or $version -lt '7.0') {
              $arch = 'x86'
            }
            $vc = $installed.VCVersion
            $ts = ""
            if(-not($installed.ThreadSafe)) {
              $ts = "nonts"
            }
            Invoke-WebRequest -UseBasicParsing -Uri "https://downloads.ioncube.com/loader_downloads/ioncube_loaders_win_$ts`_vc$vc`_$arch.zip" -OutFile $ext_dir\ioncube.zip
            Expand-Archive -Path $ext_dir\ioncube.zip -DestinationPath $ext_dir -Force
            Copy-Item $ext_dir\ioncube\ioncube_loader_win_$version.dll $ext_dir\php_ioncube.dll            
          }
          Set-Content $php_dir\php.ini â€“value "zend_extension=php_ioncube.dll`r`n" + (Get-Content $php_dir\php.ini)
          type $php_dir\php.ini
      - name: Testing PHP version
        run: php -v
      - name: Testing Extensions
        run: php -m
