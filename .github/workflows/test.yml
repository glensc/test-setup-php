name: Test workflow
on: [push]
jobs:
  run:    
    runs-on: ${{ matrix.operating-system }}
    strategy:
      fail-fast: false
      matrix:      
        operating-system: [ubuntu-20.04]
        php-versions: ['7.3']
    name: PHP ${{ matrix.php-versions }} Test on ${{ matrix.operating-system }}
    steps:
    - name: Checkout
      uses: actions/checkout@v2  

    - name: Setup PHP
      run: |
        sudo rm -rf /etc/apt/sources.list.d/*
        sudo rm -rf /etc/apt/sources.list.save /etc/apt/sources.list
        printf 'deb http://azure.archive.ubuntu.com/ubuntu %s main multiverse universe restricted\n' "$(. /etc/os-release; printf "%s" "$UBUNTU_CODENAME")"{,-security} | sudo tee /etc/apt/sources.list
        LC_ALL=C.UTF-8 sudo apt-add-repository ppa:ondrej/php -y
        sudo DEBIAN_FRONTEND=noninteractive apt-get update -y
        version='${{ matrix.php-versions }}'
        sudo mkdir -p /var/run /run/php        
        IFS=' ' read -r -a packages <<< "$(echo "cli curl mbstring xml intl" | sed "s/[^ ]*/php$version-&/g")"          
        sudo DEBIAN_FRONTEND=noninteractive apt-fast install -y "${packages[@]}" apache2- apache2-bin- libapache2-mod-php"$version"-
        for tool in pear pecl php phar phar.phar php-cgi php-config phpize phpdbg; do
          if [ -e "/usr/bin/$tool$version" ]; then
            sudo update-alternatives --set $tool /usr/bin/"$tool$version"
          fi
        done 
        
    - name: Test PHP version
      run: php -v
