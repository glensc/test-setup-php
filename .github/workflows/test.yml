name: Test workflow
on: [push]
jobs:
  run:    
    runs-on: ${{ matrix.operating-system }}
    strategy:
      fail-fast: false
      matrix:      
        operating-system: [ubuntu-latest, ubuntu-16.04]        
        php-versions: ['5.3']
    name: PHP ${{ matrix.php-versions }} Test on ${{ matrix.operating-system }}
    steps:
    - name: Checkout
      uses: actions/checkout@v1
    - name: Install PHP
      env:
        version: ${{ matrix.php-versions }}
      run: |
        apt_install="sudo DEBIAN_FRONTEND=noninteractive apt-fast install -y --allow-downgrades"
        universe=http://archive.ubuntu.com/ubuntu/pool/universe
        main=http://archive.ubuntu.com/ubuntu/pool/main
        lpd=http://launchpadlibrarian.net
        minor=$(echo $version | cut -d'.' -f 2)
        pkg=5.3.29-1~dotdeb.0
        for deb_file in "$universe"/o/openssl098/libssl0.9.8_0.9.8o-7ubuntu3.1_amd64.deb \
                        "$universe"/libo/libonig/libonig2_5.9.6-1_amd64.deb \
                        "$main"/d/db4.8/libdb4.8_4.8.30-11ubuntu1_amd64.deb \
                        "$main"/r/readline6/libreadline6_6.3-8ubuntu2_amd64.deb \
                        "$lpd"/59651391/libicu44_4.4.2-2_amd64.deb; do
          curl --retry 5 -sL -O "$deb_file"
          $apt_install install ./"${deb_file##*/}"
        done  
        echo "deb http://packages.dotdeb.org squeeze all" | sudo tee -a /etc/apt/sources.list        
        wget https://www.dotdeb.org/dotdeb.gpg
        sudo apt-key add dotdeb.gpg
        sudo apt-get update
        $apt_install php5-common=$pkg php5-cli=$pkg php5-dev=$pkg php5-cgi=$pkg php5-curl=$pkg php5-intl=$pkg
        for tool in pear pecl php phar phar.phar php-cgi php-config phpize phpdbg; do
          if [ -e "/usr/bin/$tool5" ]; then
            sudo cp /usr/bin/$tool5 /usr/bin/$tool5$minor;
          fi  
          if [ -e "/usr/bin/$tool$version" ]; then
            sudo update-alternatives --set $tool /usr/bin/"$tool$version" >/dev/null 2>&1
          fi
        done        
    - name: Testing PHP version
      run: |
        php -v
        php --ini
        php-config --extension-dir
    - name: Testing
      run: |
        php -m
        ls /usr/bin/*5.3
