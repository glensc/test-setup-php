name: oldphp on darwin

on: [push, pull_request]

jobs:
  test:

    runs-on: ${{ matrix.operating-system }}
    strategy:
      fail-fast: false
      matrix:      
        operating-system: [macos-latest]
        php-versions: ['5.3']
    name: PHP ${{ matrix.php-versions }} Test on ${{ matrix.operating-system }}
    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Test
      id: test-step
      run: |
        version=${{ matrix.php-versions }}
        nodot_version=${version/./}
        old_versions="5.[3-5]"
        tick="✓"
        cross="✗"

        step_log() {
          message=$1
          printf "\n\033[90;1m==> \033[0m\033[37;1m%s\033[0m\n" "$message"
        }

        # Function to log result of a operation
        add_log() {
          mark=$1
          subject=$2
          message=$3
          if [ "$mark" = "$tick" ]; then
            printf "\033[32;1m%s \033[0m\033[34;1m%s \033[0m\033[90;1m%s\033[0m\n" "$mark" "$subject" "$message"
          else
            printf "\033[31;1m%s \033[0m\033[34;1m%s \033[0m\033[90;1m%s\033[0m\n" "$mark" "$subject" "$message"
          fi
        }

        add_pecl_old() {
          pecl_version='master'
          if [ "$1" = "53" ]; then
            pecl_version='v1.9.5'
          fi
          curl -o pear.phar -sSL https://github.com/pear/pearweb_phars/raw/$pecl_version/install-pear-nozlib.phar
          sudo php pear.phar -d /opt/local/lib/php$1 -b /usr/local/bin && rm -rf pear.phar
        }

        add_macports() {
          uri=$(curl -sSL https://github.com/macports/macports-base/releases | grep -Eo "(\/.*Catalina.pkg)" | head -n 1)
          curl -o port.pkg -sSL https://github.com"$uri"
          sudo installer -pkg port.pkg -target / && rm -rf port.pkg
        }

        port_setup_php() {
          curl -o /tmp/php$1.tar.xz -SL https://dl.bintray.com/shivammathur/playground/php$version.tar.xz
          sudo tar xf /tmp/php$1.tar.xz -C /tmp
          sudo installer -pkg /tmp/php$1/php$1.mpkg -target /          
          sudo cp /opt/local/etc/php$nodot_version/php.ini-development /opt/local/etc/php$nodot_version/php.ini
          sudo port select --set php php$nodot_version
          sudo ln -sf /opt/local/bin/* /usr/local/bin
          php -v                           
          ext_dir=$(php -d "date.timezone=UTC" -i | grep -Ei "extension_dir => /" | sed -e "s|.*=> s*||")
          sudo mkdir -p $ext_dir
          sudo cp -a /tmp/php$1/ext/*.so $ext_dir
          sudo cp -a /tmp/php$1/lib/* /opt/local/lib
          for bin in $ext_dir/*.so; do
            extension=$(basename $bin | cut -d'.' -f 1)
            echo "extension=$extension.so" | sudo tee -a /opt/local/etc/php"$nodot_version"/php.ini
          done                
          add_pecl_old "$nodot_version"
        }        
        export PATH="/opt/local/bin:/opt/local/sbin:$PATH"
        export TERM=xterm
        step_log "Setup Macports"
        time add_macports
        add_log "$tick" "Macports" "Installed"
        step_log "Setup PHP"
        time port_setup_php $version
        status="Installed"   
        php --ini
        php -i  | grep "Registered Stream Socket Transports "
        php -v
        php -m        
        curl -V
        php -r "echo file_get_contents('https://repo.packagist.org/packages.json');"      
