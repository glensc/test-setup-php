name: Build PHP
on:
  push:
jobs:
  build:
    name: Build PHP ${{ matrix.php-version }} on ${{ matrix.operating-system }}
    runs-on: ${{ matrix.operating-system }}
    container: ubuntu:precise
    strategy:
      fail-fast: false
      matrix:
        operating-system: [ubuntu-latest]
        php-version: ['5.3']
        type: ['cgi', 'fpm']
    steps:
      - name: Install required packages
        run: |
          debconf_fix="DEBIAN_FRONTEND=noninteractive"
          apt-get update
          apt-get install sudo curl python-software-properties -y
          LC_ALL=C.UTF-8 sudo apt-add-repository ppa:ondrej/php -y
          LC_ALL=C.UTF-8 sudo apt-add-repository ppa:ubuntu-toolchain-r/test
          sudo "$debconf_fix" apt-get update
          sudo "$debconf_fix" apt-get -y install build-essential checkinstall zlib1g-dev automake autoconf bzip2 git m4 make libstdc++6-4.7-dev gcc-4.7 g++-4.7 gettext expect locales language-pack-de re2c mysql-server postgresql pkg-config libcurl4-gnutls-dev libacl1 libapache2-mod-php5 libapr1 libaprutil1 libaprutil1-dbd-freetds libaprutil1-dbd-mysql libaprutil1-dbd-odbc libaprutil1-dbd-pgsql libaprutil1-dbd-sqlite3 libaprutil1-ldap libasn1-8-heimdal libattr1 libblkid1 libbz2-dev libc6 libcap2 libc-bin libclass-isa-perl libcomerr2 libdb5.1 libdbus-1-3 libdebian-installer4 libdrm2 libdrm-intel1 libdrm-nouveau1a libdrm-radeon1 libexpat1 libenchant-dev libffi6 libgcc1 libgcrypt11 libgdbm3 libglib2.0-0 libgnutls26 libgpg-error0 libgssapi3-heimdal libgssapi-krb5-2 libgmp-dev libhcrypto4-heimdal libheimbase1-heimdal libheimntlm0-heimdal libhx509-5-heimdal libk5crypto3 libkeyutils1 libklibc libkrb5-26-heimdal libkrb5-3 libkrb5support0 libldap-2.4-2 libldb-dev libldap-dev libltdl7 liblzma5 libmagic1 libmount1 libmysqlclient18 libncurses5 libncursesw5 libnewt0.52 libnih1 libnih-dbus1 libodbc1 libp11-kit0 libpam0g libpam-modules libpam-modules-bin libpciaccess0 libpcre3 libplymouth2 libpng-dev libjpeg-dev libpspell-dev libpq5 libreadline6 librecode-dev libroken18-heimdal libsasl2-2 libselinux1 libsnmp-dev libslang2 libsqlite3-0 libssl1.0.0 libswitch-perl libsybdb5 libtasn1-3 libtextwrap1 libtinfo5 libudev0 libuuid1 libwind0-heimdal libxml2-dev libzip-dev
          sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-4.7 4
          sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-4.7 4
          sudo ln -sf /usr/lib/libc-client.so.2007e.0 /usr/lib/x86_64-linux-gnu/libc-client.a
          sudo mkdir -p /usr/c-client/
          sudo ln -sf /usr/lib/libc-client.so.2007e.0 /usr/c-client/libc-client.a
          curl -o /tmp/libc.deb -sL http://archive.ubuntu.com/ubuntu/pool/main/e/eglibc/libc6_2.19-0ubuntu6_amd64.deb
          sudo dpkg -i /tmp/libc.deb

      - name: Checkout
        uses: actions/checkout@v2

      - name: Compile and install packages
        run: sudo bash .github/scripts/deps

      - name: Build and ship
        run: chmod a+x .github/scripts/build.sh && .github/scripts/build.sh
        env:
          PHP_VERSION: ${{ matrix.php-version }}
          TYPE: ${{ matrix.type }}
      - name: Test versions
        run: |
          php -v | head -n 1
          php-cgi -v | head -n 1
          pecl -V
          php-config --version
          phpize -v
          php -m
