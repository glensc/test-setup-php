name: Test macOS workflow
on: [push]
env:
  HOMEBREW_CHANGE_ARCH_TO_ARM: 1
jobs:
  run:    
    runs-on: ${{ matrix.operating-system }}
    strategy:
      fail-fast: false
      matrix:      
        operating-system: [macos-10.15, macos-11, macos-11-arm64]
        php: [7.4]
        #php: ['5.6', '7.0', '7.1', '7.2', '7.3', '7.4', '8.0', '8.1']
    name: Test
    steps:
    - name: Setup PHP
      env:
        PHP_VERSION: ${{ matrix.php }}
      run: |
        brew tap shivammathur/php
        brew reinstall shivammathur/php/php@"$PHP_VERSION"
        brew unlink php@"$PHP_VERSION" || true
        brew link --force --overwrite php@"$PHP_VERSION"

    - name: Test PHP
      run: |
        php -v && php -m

    - name: Install and configure Apache
      env:
        PHP_VERSION: ${{ matrix.php }}
      run: |
        brew reinstall httpd || true
        httpd_config="$(brew --prefix)"/etc/httpd/httpd.conf

        cp -f "$httpd_config" "$httpd_config".bak
        
        sudo lsof -i | grep ':80' | awk '{print $2}' | xargs sudo kill -9

        sed -i '' -e "s/Listen 8080/Listen 80/" \
                  -e "s/User _www/User $(id -un)/" \
                  -e "s/User _www/Group $(id -gn)/" \
                  -e '/^#.*mod_rewrite.so/ s/^#//' \
                  -e 's/AllowOverride None/AllowOverride All/1' \
                  -e 's/#ServerName www.example.com:8080/ServerName localhost/' \
                  -e 's/DirectoryIndex index.html/DirectoryIndex index.php index.html/' "$httpd_config"

        [ "$PHP_VERSION" = "5.6" ] && mod_name=php5_module && mod_lib=libphp5.so
        [[ "$PHP_VERSION" =~ 7.[0-4] ]] && mod_name=php7_module && mod_lib=libphp7.so
        [[ "$PHP_VERSION" =~ 8.[0-1] ]] && mod_name=php_module && mod_lib=libphp.so
        echo "LoadModule $mod_name $(brew --prefix)/opt/php@"$PHP_VERSION"/lib/httpd/modules/$mod_lib" >> "$httpd_config"

        echo "<FilesMatch \.php$>
          SetHandler application/x-httpd-php
        </FilesMatch>" >> "$httpd_config"
        
        sudo chown -R "$(id -un)":"$(id -gn)" $(brew --prefix)/var/www

        sudo apachectl
        cat "$httpd_config"

    - name: Restart Apache
      run: |
        brew services restart httpd
        brew services list

    - name: Check SAPI setup
      run: |
        echo "<?php echo current(explode('-', php_sapi_name())).':'.strtolower(current(explode('/', \$_SERVER['SERVER_SOFTWARE']))).\"\n\";" > "$(brew --prefix)"/var/www/index.php
        curl -vvv http://localhost
        resp="$(curl -s http://localhost)"
        [ "apache2handler:apache" != "$resp" ] && exit 1 || echo "$resp"

    - name: Add test script
      run: |
        echo "
        <?php
        \$ch = curl_init();
        curl_setopt(\$ch, CURLOPT_URL, 'https://duckduckgo.com');
        curl_setopt(\$ch, CURLOPT_HEADER, true);
        curl_setopt(\$ch, CURLOPT_NOBODY, true);
        curl_setopt(\$ch, CURLOPT_RETURNTRANSFER, true);
        echo curl_exec(\$ch);
        curl_close(\$ch);" > "$(brew --prefix)"/var/www/test.php

    - name: Test with php cli
      run: php "$(brew --prefix)"/var/www/test.php

    - name: Test with apache
      run: curl -s http://localhost/test.php
      
    - name: Cleanup
      if: ${{ always() }}
      env:
        PHP_VERSION: ${{ matrix.php }}
      run: |
        brew services stop httpd
        httpd_config="$(brew --prefix)"/etc/httpd/httpd.conf
        cp -f "$httpd_config".bak "$httpd_config"
        brew remove php@"$PHP_VERSION" httpd
        brew untap shivammathur/php
