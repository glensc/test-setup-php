name: Build

on:
    push:
    pull_request:
    release:
        types: [created]

jobs:
    tests:
        runs-on: ubuntu-latest
        name: Build and test
        strategy:
            fail-fast: false
            matrix:
                php: [7.0, 7.1, 7.2, 7.3, 7.4, 8.0, 8.1]

        steps:
            -   uses: actions/checkout@v2

            -   name: Setup PHP
                uses: shivammathur/setup-php@v2
                with:
                    php-version: "${{ matrix.php }}"
                    coverage: none
                    ini-values: "session.save_path=/tmp"
                    extensions: json
                    tools: pecl

            -   name: Compile
                run: ./.github/workflows/compile.sh

            -   name: Run tests
                run: |
                    export INI_DIR=/etc/php/${{ matrix.php }}/cli/
                    export INI_FILE=/etc/php/${{ matrix.php }}/cli/php.ini
                    php -m
                    php --rf "json_decode"
                    make -j 5 test && if ls tests/*.diff >/dev/null 2>&1; then echo "Tests failed" && cat tests/*.diff && exit 1; fi

            -   name: Show errors
                if: ${{ failure() }}
                run: |
                  cat tests/bug0016.sh
                  ./.github/workflows/show-errors.sh

            -   name: Do GCOV
                if: ${{ failure() }}
                run: |
                    gcov --object-directory .libs *.c
                    bash <(curl -s https://codecov.io/bash)
